<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Комментарии</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {% load static %}
    <link rel="stylesheet" href="{% static 'comments/style.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2>Оставить комментарий</h2>
    {% include 'comments/includes/form.html' %}

    {% if comments %}<h2 class="mt-4">Комментарии</h2> {% endif %}
    {% for comment in comments %}
    {% include 'comments/includes/comment_block.html' with comment=comment %}
{% endfor %}

    <div class="pagination">
        {% if is_paginated %}
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}">← Назад</a>
            {% endif %}
            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Вперёд →</a>
            {% endif %}
        {% endif %}
    </div>
</div>

<!-- Шаблон для inline-формы -->
<template id="reply-form-template">
    <form method="post" enctype="multipart/form-data" class="reply-form border p-3 bg-light rounded mt-3">
        {% csrf_token %}
        <input type="hidden" name="parent_id" value="">

        <div class="mb-2">
            <input type="text" name="user_name" class="form-control" placeholder="Ваше имя" required>
        </div>

        <div class="mb-2">
            <input type="email" name="email" class="form-control" placeholder="Email" required>
        </div>

        <div class="mb-2">
            <input type="url" name="home_page" class="form-control" placeholder="Сайт (необязательно)">
        </div>

        <div class="mb-2">
            <textarea name="text" class="form-control" rows="3" placeholder="Сообщение" required></textarea>
        </div>

        <div class="mb-2">
            <input type="file" name="files" multiple class="form-control">
        </div>

        <div class="mb-2">
            <label>CAPTCHA:</label>
            {{ form.captcha }}
        </div>

        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-sm btn-primary">Отправить</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelInlineReply(this)">Отменить
            </button>
        </div>
    </form>
</template>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>



<script>
    function showReplyForm(button, parentId) {
        // Удалить предыдущую форму
        document.querySelectorAll('.reply-form').forEach(el => el.remove());

        const template = document.getElementById('reply-form-template');
        const formClone = template.content.cloneNode(true);

        // Установить parent_id
        formClone.querySelector('input[name="parent_id"]').value = parentId;

        // Вставить форму под комментарием
        button.parentNode.appendChild(formClone);
    }

    function cancelInlineReply(btn) {
        btn.closest('.reply-form').remove();
    }
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('.comment-form');
    if (!form) return;

    form.addEventListener('submit', function (e) {
        let errors = [];

        const username = form.querySelector('input[name="user_name"]').value.trim();
        const email = form.querySelector('input[name="email"]').value.trim();
        const text = form.querySelector('textarea[name="text"]').value.trim();
        const files = form.querySelector('input[name="files"]').files;

        const usernameRegex = /^[a-zA-Z0-9]+$/;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!usernameRegex.test(username)) {
            errors.push("Имя пользователя должно содержать только латинские буквы и цифры.");
        }

        if (!emailRegex.test(email)) {
            errors.push("Введите корректный email.");
        }

        if (!text) {
            errors.push("Поле текста не может быть пустым.");
        }

        for (const file of files) {
            const ext = file.name.split('.').pop().toLowerCase();
            const allowed = ['jpg', 'jpeg', 'png', 'gif', 'txt'];
            if (!allowed.includes(ext)) {
                errors.push(`Файл ${file.name}: недопустимый формат.`);
            }
            if (ext === 'txt' && file.size > 100 * 1024) {
                errors.push(`Файл ${file.name}: TXT-файл больше 100KB.`);
            }
        }

        if (errors.length > 0) {
            e.preventDefault();
            alert(errors.join("\n"));
        }
    });
});
</script>

<script>
function wrapTag(tag) {
    const textarea = document.querySelector('textarea[name="text"]');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);

    const wrapped = `<${tag}>${selectedText}</${tag}>`;
    textarea.value = before + wrapped + after;

    textarea.focus();
    textarea.setSelectionRange(start + tag.length + 2, end + tag.length + 2); // ставим курсор внутрь
}

function insertLink() {
    const textarea = document.querySelector('textarea[name="text"]');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end) || "текст ссылки";

    const url = prompt("Введите URL:", "https://");
    if (!url) return;

    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    const linked = `<a href="${url}">${selectedText}</a>`;

    textarea.value = before + linked + after;
    textarea.focus();
    textarea.setSelectionRange(before.length + 9, before.length + 9 + url.length); // курсор на href
}
</script>

</body>
</html>
